# Scenario 4: Orchestration with HTTP Request-Response 

This scenario tests a simple BizTalk application that consists of the following:
 - Receive Port
    - Two-Way
    - 2 Receive Maps specified  
 - Receive Location
    - Http Adapter 
    - Custom Receive Pipeline using JsonDecoder, XmlDisassembler and XmlValidator
    - Custom Send Pipeline using JsonEncoder and XmlAssembler
 - Orchestration
    - Receive Port and Type (specify later binding)
    - Send Port and Type (specify later binding)
    - Constructs a new message using a Transform shape and sends out this new message
 - Binding File
    - Maps the orchestration receive port to the HTTP Receive port
    - Maps the orchestration send port to the HTTP Response port

Effectively, this scenario tests that we can receive a JSON request via the Http Adapter, convert it to XML, transform it in the Receive Port, send it to the messagebox, subscribe to it in an orchestration, create a new message by transforming the received message, send the new message to the messagebox, subscribe to the response via the Http Receive Port, execute the send pipeline and transform the XML back to JSON, and return a response back to the caller.

To test this scenario, perform the following steps:
1. Install the tool and Azure CLI as per the QuickStart steps.
2. Decide on a unique ID to use for your deployment e.g. a shortened version of your name, or your company's name. This helps ensure that any resources which need a globally unique name do not have a clash with other similarly-named resources. Wherever you see &lt;dep&gt; below, replace this with your *Unique Deployment Id*.  
3. Locate the *Scenario 4* MSI file in the aimbiztalk repo: `/aimbiztalk/scenarios/004-HttpJsonOrch/msi/Aim.HttpJsonOrch.msi`.
4. Download this MSI, and open a PowerShell prompt/command prompt/Windows Terminal in the same folder.
5. Run the tool over this msi, specifying the location of the downloaded MSI e.g. `aim migrate -a "microsoft.biztalk.msidiscoverer.msifiles=C:\Temp\SampleMSIs\Aim.HttpJsonOrch.msi" --primary-region "West US" --unique-deployment-id <your unique id>`.
6. Login to your tenant using `az login`.
7. If you have multiple subscriptions, check that the subscription you wish to use is set as the default subscription - if it isn't, issue this command to switch to the correct subscription: `az account set --subscription "<subscription name or id>"`.
8. The tool will have created a new folder (with a name similar to aim-xxxxx) in the current folder.
9.  Execute the deployment scripts by typing this in the terminal (replacing 'xxxxx' with the unique code generated by the tool when it ran): `.\aim-xxxxx\conversion\Deploy-All.ps1`.
10. If this is your first deployment, and APIM hasn't been deployed, be prepared to wait for over 45 minutes - *Azure API Management* takes over 30 mins to provision. Note: the terminal may not show any progress for a while - don't be tempted to cancel it, as doing this leaves APIM only partially deployed, and it can take up to 2 hours for APIM to recover.
If you've already performed a deployment (using the same unique deployment id) then the deployment will take up to 15 minutes.
11. Open the Http Receive Adapter logic app (`logic-aimhttpradapter-purchaseorderhttpjsonreceive-dev-<dep>` in Resource Group `rg-aimapp-aim-httpjsonorch-dev-<region>-<dep>`) and copy the *HTTP POST URL* value.
12. Open a tool such as PostMan and POST a request to this URL - a sample request can be found in `/aimbiztalk/scenarios/004-HttpJsonOrch/samplemessages/PurchaseOrderRequest.json`.
13. Wait. For a cold start, it takes over 2 minutes for a response, and Postman will time out. Subsequent requests will take around 30-40 seconds, depending on the polling values for the triggers in the ProcessManager (orchestration) and Send Port Logic Apps. For more info on performance (and what we're doing about it) see the [Frequently Asked Questions](./../../frequently-asked-questions.md).

# Troubleshooting
If the response doesn't appear after about a minute (after an initial cold start), check for the following:
 - Check the run history for the Http Receive Adapter logic app - follow the flow of the *Respond:_Were_we_successful* decision action, and see if we received an ACK or a NACK back from the call to the MessageConstructor logic app (alternatively you can create a subscription on the SuspendQueue in ServiceBus and create a LogicApp that alerts you via email if a message is suspended).
 - If an ACK was received, then check the run history for the Orchestration (Process Manager) Logic App and check that it subscribed to a message, and received an ACK when it published it.
 - If the Process Manager executed correctly, then check the run history for the Send Adapter Logic App and check that it subscribed to a message, and sent the a response.
 - If no message was subscribed to, check that the message published by the TopicPublisher logic app (in the Resource Group called `rg-aimapp-systemapplication-dev-<region>-<dep>`) has the correct properties set to match the subscription created for the Process Manager logic app.
