# Scenario 1: FTP Passthrough Messaging

This scenario tests a simple BizTalk application that consists of the following:
 - Receive Port
    - One-Way
 - Receive Location
    - FTP Adapter 
    - Pass-Thru Receive Pipeline
 - Send Port
    - One-Way
    - FTP Adapter
    - Filter using BTS.ReceivePortName (set to the name of the Receive Port)

Effectively, this scenario tests that we can receive a file via FTP, send it to the messagebox, subscribe to it and send it out via FTP.

To test this scenario, perform the following steps:
1. Install the tool and Azure CLI as per the QuickStart steps, and identity an FTP server you can use.
2. Decide on a unique ID to use for your deployment e.g. a shortened version of your name, or your company's name. This helps ensure that any resources which need a globally unique name do not have a clash with other similarly-named resources.
3. Locate the *Scenario 1* MSI file in the aimbiztalk repo: `aimbiztalk/scenarios/001-FtpPassthru/msi/Aim.FtpPassthru.msi`.
4. Download this MSI, and open a PowerShell prompt/command prompt/Windows Terminal in the same folder.
5. Run the tool over this msi, specifying the location of the downloaded MSI e.g. `aim migrate -a "microsoft.biztalk.msidiscoverer.msifiles=C:\Temp\SampleMSIs\Aim.FtpPassthru.msi" --primary-region "West US" --unique-deployment-id <your unique id>`.
6. Login to your tenant using `az login`.
7. If you have multiple subscriptions, check that the subscription you wish to use is set as the default subscription - if it isn't, issue this command to switch to the correct subscription: `az account set --subscription "<subscription name or id>"`.
8. The tool will have created a new folder (with a name similar to aim-xxxxx) in the current folder.
9. Change the *FTP Receive Folder* and *File Mask* to match your file server: edit the file`\conversion\applications\aim-ftppassthru\endpoints\ftpreceivelocation\azuredeploy.ftpreceiveadapter.logicapp.dev.parameters.json` and change the *ftpReceiveFolder* and *ftpFileMask* values to match your setup.
10. Change the Send Adapter *Send Folder* and *Send File Name* if necessary: edit the file `\conversion\applications\aim-ftppassthru\endpoints\ftpsendport\azuredeploy.ftpsendadapter.apiconnection.dev.parameters.json` and change the *ftpSendFolder* and *ftpSendFileName* values as needed.
11. Execute the deployment scripts by typing this in the terminal (replacing 'xxxxx' with the unique code generated by the tool when it ran): `.\aim-xxxxx\conversion\Deploy-All.ps1`.
12. If this is your first deployment, and APIM hasn't been deployed, be prepared to wait for over 45 minutes - *Azure API Management* takes over 30 mins to provision. Note: the terminal may not show any progress for a while - don't be tempted to cancel it, as doing this leaves APIM only partially deployed, and it can take up to 2 hours for APIM to recover.
If you've already performed a deployment (using the same unique deployment id) then the deployment will take up to 15 minutes.
12. Find the *API Connection* for the receive and send FTP Adapters, and modify them with your own FTP server and login details. The API Connections can be found here (where &lt;dep&gt; is the unique deployment id you chose when you ran the tool):  
    - Resource Group: `rg-aimapp-aim-ftppassthru-dev-<region>-<dep>`  
    - FTP Receive API Connection: `apic-aimftprconnector-ftpreceivelocation-dev-<dep>`  
    - FTP Send API Connection: `apic-aimftpsconnector-ftpsendport-dev-<dep>`  
13. Copy a file (which matches the filemask) into the FTP Receive Folder. After a certain amount of time (around 60 seconds for a cold start, and 15-30 seconds for a warm start) the file should appear in the send folder on your FTP Server.

# Troubleshooting
If the file doesn't appear after about a minute, check for the following:
 - Check the run history for the FTP Receive Adapter logic app - follow the flow of the *Respond:_Were_we_successful* decision action, and see if we received an ACK or a NACK back from the call to the MessageConstructor logic app (alternatively you can create a subscription on the SuspendQueue in ServiceBus and create a LogicApp that alerts you via email if a message is suspended).
 - If an ACK was received, then check the run history for the FTP Send Adapter and check that it subscribed to a message.
 - If no message was subscribed to, check that the message published by the TopicPublisher logic app (in the Resource Group called `rg-aimapp-systemapplication-dev-<region>-<dep>`) has the correct properties set to match the subscription created for the Send Port.
