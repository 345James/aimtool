# Scenario 3: Orchestration with One-Way Send and Receive

This scenario tests a simple BizTalk application that consists of the following:
 - Receive Port
    - One-Way
 - Receive Location
    - File Adapter 
    - Pass-Thru Pipeline
 - Orchestration
    - Receive Port and Type (specify later binding)
    - Send Port and Type (specify later binding)
    - Sends out the received message
 - Send Port
    - One-Way
    - File Adapter
 - Binding File
    - Maps the orchestration receive port to the File Receive port
    - Maps the orchestration send port to the File Send port

Effectively, this scenario tests that we can receive a file via the File Adapter, send it to the messagebox, subscribe to it in an orchestration, send it back to the messagebox, subscribe to it in a Send Port, and send it out as a File.

To test this scenario, perform the following steps:
1. Install the tool and Azure CLI as per the QuickStart steps.
2. Decide on a unique ID to use for your deployment e.g. a shortened version of your name, or your company's name. This helps ensure that any resources which need a globally unique name do not have a clash with other similarly-named resources.
3. Install *On-Premises Data Gateway* (OPDG) on the PC acting as your File server - you can do this manually, or you can use the script located in the aimazure repo: 
   `aimazure/tests/onpremisedatagateway/Deploy-10-OnPremiseDataGateway.ps1`  passing it a single parameter: `-uniqueDeploymentId "xxxxxx"` (where 'xxxxx' should be the deployment you chose above).  
   Edit the `azuredeploy.filegateway.opdg.dev.psparameters.json` file (in the same folder) to change the region to the one you'll be using for the scenario deployment.
4. Locate the *Scenario 3* MSI file in the aimbiztalk repo: `aimbiztalk/scenarios/003-SimpleOrchestration/msi/Aim.SimpleOrchestration.msi`.
5. Download this MSI, and open a PowerShell prompt/command prompt/Windows Terminal in the same folder.
6. Run the tool over this msi, specifying the location of the downloaded MSI e.g. `aim migrate -a "microsoft.biztalk.msidiscoverer.msifiles=C:\Temp\SampleMSIs\Aim.SimpleOrchestration.msi" --primary-region "West US" --unique-deployment-id <your unique id>`.
7. Login to your tenant using `az login`.
8. If you have multiple subscriptions, check that the subscription you wish to use is set as the default subscription - if it isn't, issue this command to switch to the correct subscription: `az account set --subscription "<subscription name or id>"`.
9. The tool will have created a new folder (with a name similar to aim-xxxxx) in the current folder.
10. If you've changed the name of the OPDG deployment, or you're using your own OPDG install, edit the following file: `\conversion\applications\systemapplication\datagateway\azuredeploy.datagateway.onpremisedatagateway.dev.psparameters.json` and change the *connectionGatewayInstallationDisplayName* and (optionally) the *connectionGatewayInstallationLocation* value.
11. Change the *File Receive Location* to match your file server: edit the file`\conversion\applications\aim-xmlmapping\endpoints\filereceivelocation\azuredeploy.filereceiveadapter.logicapp.dev.parameters.json` and change the *fileReceiveFolder* value to match your setup.
12. Change the *Receive File Mask* to match your file server (if need be - it defaults to &#42;.xml): edit the file `\conversion\applications\aim-xmlmapping\config\aim.xmlmapping.filereceiveport.filereceivelocation\aim.xmlmapping.filereceiveport.filereceivelocation.configurationentry.json` and change the *fileMask* entry under *fileReceiveAdapter*. Note that after deployment, this value is stored in Azure App Config - with the FTP Adapter, this value is part of the Logic App. This is a known issue that will be fixed in future.
13. Change the Send Adapter *Destination Folder* and *Send File Name* if necessary: edit the file `\conversion\applications\aim-xmlmapping\config\aim.xmlmapping.filesendport\aim.xmlmapping.filesendport.configurationentry.json` and change the *destinationFolder* and *fileName* values under *fileSendAdapter*.
14. Execute the deployment scripts by typing this in the terminal (replacing 'xxxxx' with the unique code generated by the tool when it ran): `.\aim-xxxxx\conversion\Deploy-All.ps1`.
15. If this is your first deployment, and APIM hasn't been deployed, be prepared to wait for over 45 minutes - *Azure API Management* takes over 30 mins to provision. Note: the terminal may not show any progress for a while - don't be tempted to cancel it, as doing this leaves APIM only partially deployed, and it can take up to 2 hours for APIM to recover.
If you've already performed a deployment (using the same unique deployment id) then the deployment will take up to 15 minutes.
10. Find the *API Connection* for the receive and send File Adapters, and modify them with your own root folder and login details. The API Connections can be found here (where &lt;dep&gt; is the unique deployment id you chose when you ran the tool):  
    - Resource Group: `rg-aimapp-aim-xmlmapping-dev-<region>-<dep>`  
    - File Receive API Connection: `apic-aimfilerconnector-filereceivelocation-dev-<dep>`  
    - File Send API Connection: `apic-aimfilesconnector-filesendport-dev-<dep>`  
11. Copy a file (which matches the filemask) into the File Receive Folder. After a certain amount of time (around 60 seconds for a cold start, and 15-30 seconds for a warm start) the file should appear in the send folder on your File Server.

# Troubleshooting
If the file doesn't appear after about a minute, check for the following:
 - Check the run history for the File Receive Adapter logic app - follow the flow of the *Respond:_Were_we_successful* decision action, and see if we received an ACK or a NACK back from the call to the MessageConstructor logic app (alternatively you can create a subscription on the SuspendQueue in ServiceBus and create a LogicApp that alerts you via email if a message is suspended).
 - If an ACK was received, then check the run history for the Orchestration (Process Manager) Logic App and check that it subscribed to a message, and received an ACK when it published it.
 - If the Process Manager executed correctly, then check the run history for the File Send Adapter Logic App and check that it subscribed to a message, and sent the file.
 - If no message was subscribed to, check that the message published by the TopicPublisher logic app (in the Resource Group called `rg-aimapp-systemapplication-dev-<region>-<dep>`) has the correct properties set to match the subscription created for the Process Manager logic app.
